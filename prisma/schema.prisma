// Prisma schema for Co-Sleep app
// Models: User, SleepSession, Block, Favorite, Report, Rating, Subscription, SleepAnalytics, BackgroundSound, UserSound
// All relations and fields are documented for clarity

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// User Management
// =====================
model User {
  id              String   @id @default(cuid())
  
  // Authentication fields
  email           String?  @unique
  password        String?
  username        String?  @unique
  name            String?
  
  // Onboarding fields
  userType        String   @default("anonymous") // "anonymous" or "profile"
  displayName     String?  // Only for profile users
  genderIdentity  String?  // e.g., "male", "female", "nonbinary", "prefer_not_to_say"
  matchPreference String?  // e.g., "any", "male", "female", "nonbinary"
  consentGiven    Boolean  @default(false)
  onboardingStep  String   @default("welcome") // Track onboarding progress
  
  // Hence Enhancement: Verification and Activity Tracking
  isVerified      Boolean  @default(false)  // For history feature access
  lastActivity    DateTime @default(now())  // Track user activity
  connectionState String   @default("idle") // idle, searching, matched, connected
  
  // Premium features disabled for freemium version
  // isPremium       Boolean  @default(false)
  // premiumUntil    DateTime?
  // stripeCustomerId String? @unique
  // stripeSubscriptionId String? @unique
  timezone        String?
  sleepTime       String?
  wakeTime        String?
  // backgroundSounds String[] @default([]) // Removed for freemium version
  autoDisconnect  Boolean  @default(false)
  disconnectTime  Int?     // in minutes
  allowAnalytics  Boolean  @default(true)
  showOnline      Boolean  @default(true)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  sleepSessions    SleepSession[] @relation("UserSessions")      // Sessions as user
  partnerSessions  SleepSession[] @relation("PartnerSessions")   // Sessions as partner
  analytics        SleepAnalytics?
  callHistory      CallHistory[]                                 // Hence: Call history tracking

  @@map("users")
}

// =====================
// Sleep Sessions (voice call sessions between users)
// =====================
model SleepSession {
  id          String   @id @default(cuid()) // Unique session ID
  userId      String                          // User who started session
  partnerId   String?                         // Optional partner user ID
  startTime   DateTime                        // Session start time
  endTime     DateTime?                       // Session end time
  duration    Int?     // in minutes          // Session duration
  quality     Int?     // 1-5 rating          // User-reported quality
  notes       String?                         // Optional session notes
  createdAt   DateTime @default(now())        // Record creation timestamp

  // Connection Details
  connectionQuality String?                   // "excellent", "good", etc.
  iceServersUsed   String[]                   // ICE servers used for connection
  connectionType   String?                    // "direct", "relay", "host"

  // User Relationships
  user        User     @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade) // Session owner
  partner     User?    @relation("PartnerSessions", fields: [partnerId], references: [id], onDelete: SetNull) // Session partner

  @@map("sleep_sessions")
}

// =====================
// Hence Enhancement: Call History
// =====================
model CallHistory {
  id              String   @id @default(cuid())
  userId          String                          // User who made the call
  partnerId       String?                         // Partner user ID (if known)
  partnerType     String?                         // "anonymous" or "profile"
  startTime       DateTime                        // Call start time
  endTime         DateTime?                       // Call end time
  duration        Int?     // in seconds          // Call duration in seconds
  connectionQuality String?                       // "excellent", "good", "fair", "poor"
  endReason       String?                         // "completed", "disconnected", "skipped"
  userRating      Int?     // 1-5 rating          // User's rating of the call
  createdAt       DateTime @default(now())        // Record creation timestamp

  // User relationship
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("call_history")
}

// =====================
// Sleep Analytics
// =====================
model SleepAnalytics {
  id                    String   @id @default(cuid())
  userId                String   @unique
  totalSessions         Int      @default(0)
  totalDuration         Int      @default(0) // in minutes
  averageQuality        Float    @default(0)
  favoritePartners      String[] @default([])
  preferredTimes        String[] @default([])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // User relationship
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sleep_analytics")
}
