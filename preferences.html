<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preferences - Co-Sleep</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="sounds.js"></script>
    <script src="analytics.js"></script>
    <script src="preferences.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">Co-Sleep</div>
            <div class="header-right">
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="user-menu" id="user-menu" style="display: none;">
                    <button class="user-btn" onclick="toggleUserMenu()">
                        <i class="fas fa-user-circle"></i>
                        <span id="user-name">User</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <a href="#" onclick="showProfile()"><i class="fas fa-user"></i> Profile</a>
                        <a href="#" onclick="showAnalytics()"><i class="fas fa-chart-line"></i> Analytics</a>
                        <a href="#" onclick="upgradePremium()"><i class="fas fa-crown"></i> Upgrade</a>
                        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container preferences-container">
        <!-- Preferences Header -->
        <div class="preferences-header">
            <h1><i class="fas fa-cog"></i> Preferences</h1>
            <p>Customize your co-sleep experience</p>
        </div>

        <!-- Preferences Form -->
        <form id="preferences-form" class="preferences-form">
            <!-- Sleep Schedule -->
            <div class="preference-section">
                <h2><i class="fas fa-moon"></i> Sleep Schedule</h2>
                <div class="form-group">
                    <label for="sleep-time">Bedtime</label>
                    <input type="time" id="sleep-time" name="sleepTime" value="22:00">
                </div>
                <div class="form-group">
                    <label for="wake-time">Wake Time</label>
                    <input type="time" id="wake-time" name="wakeTime" value="07:00">
                </div>
                <div class="schedule-info">
                    <span id="sleep-duration">9h sleep duration</span>
                    <span id="time-until-sleep">8h 30m until sleep</span>
                </div>
            </div>

            <!-- Sound Preferences -->
            <div class="preference-section">
                <h2><i class="fas fa-volume-up"></i> Sound Preferences</h2>
                <div class="form-group">
                    <label for="default-sound">Default Background Sound</label>
                    <select id="default-sound" name="defaultSound">
                        <option value="">No default sound</option>
                        <option value="ocean">üåä Ocean Waves</option>
                        <option value="rain">üåßÔ∏è Rain</option>
                        <option value="whiteNoise">ü§´ White Noise</option>
                        <option value="forest">üå≤ Forest Night</option>
                        <option value="fireplace">üî• Fireplace (Premium)</option>
                        <option value="cafe">‚òï Cafe Ambience (Premium)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sound-volume-pref">Default Volume</label>
                    <input type="range" id="sound-volume-pref" name="soundVolume" min="0" max="100" value="30">
                    <span class="volume-display">30%</span>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="auto-play-sound" name="autoPlaySound">
                        Auto-play default sound when starting sessions
                    </label>
                </div>
            </div>

            <!-- Auto-Disconnect Settings -->
            <div class="preference-section">
                <h2><i class="fas fa-clock"></i> Auto-Disconnect</h2>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="auto-disconnect" name="autoDisconnect" checked>
                        Enable auto-disconnect
                    </label>
                </div>
                <div class="form-group">
                    <label for="disconnect-time">Disconnect after (minutes)</label>
                    <input type="number" id="disconnect-time" name="disconnectTime" min="15" max="480" value="60">
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="disconnect-after-sleep" name="disconnectAfterSleep" checked>
                        Disconnect when sleep time is reached
                    </label>
                </div>
            </div>

            <!-- Privacy Settings -->
            <div class="preference-section">
                <h2><i class="fas fa-shield-alt"></i> Privacy</h2>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="show-online" name="showOnline" checked>
                        Show online status to others
                    </label>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="allow-analytics" name="allowAnalytics" checked>
                        Allow analytics collection (helps improve the app)
                    </label>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="allow-notifications" name="allowNotifications" checked>
                        Allow notifications
                    </label>
                </div>
            </div>

            <!-- Connection Preferences -->
            <div class="preference-section">
                <h2><i class="fas fa-wifi"></i> Connection</h2>
                <div class="form-group">
                    <label for="connection-type">Preferred Connection Type</label>
                    <select id="connection-type" name="preferredConnectionType">
                        <option value="auto">Auto (Recommended)</option>
                        <option value="direct">Direct (Faster, may not work)</option>
                        <option value="relay">Relay (Slower, more reliable)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="connection-timeout">Connection Timeout (seconds)</label>
                    <input type="number" id="connection-timeout" name="connectionTimeout" min="10" max="60" value="30">
                </div>
            </div>

            <!-- UI Preferences -->
            <div class="preference-section">
                <h2><i class="fas fa-palette"></i> Appearance</h2>
                <div class="form-group">
                    <label for="theme">Theme</label>
                    <select id="theme" name="theme">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="compact-mode" name="compactMode">
                        Compact mode (smaller interface)
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="preferences-actions">
                <button type="submit" class="save-btn">
                    <i class="fas fa-save"></i> Save Preferences
                </button>
                <button type="button" class="reset-btn" onclick="resetPreferences()">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
                <button type="button" class="export-btn" onclick="exportPreferences()">
                    <i class="fas fa-download"></i> Export
                </button>
                <button type="button" class="import-btn" onclick="importPreferences()">
                    <i class="fas fa-upload"></i> Import
                </button>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Customize your experience ‚Ä¢ <a href="#" target="_blank">Privacy</a></p>
    </footer>

    <script>
        // Initialize preferences page
        document.addEventListener('DOMContentLoaded', () => {
            if (window.preferencesManager) {
                window.preferencesManager.init();
                loadPreferencesForm();
                updateScheduleInfo();
            }
        });

        // Load preferences into form
        function loadPreferencesForm() {
            const prefs = window.preferencesManager.getAll();
            
            // Set form values
            Object.keys(prefs).forEach(key => {
                const element = document.querySelector(`[name="${key}"]`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = prefs[key];
                    } else {
                        element.value = prefs[key];
                    }
                }
            });

            // Update volume display
            updateVolumeDisplay();
        }

        // Update schedule information
        function updateScheduleInfo() {
            if (window.preferencesManager) {
                const schedule = window.preferencesManager.getSleepSchedule();
                const timeUntil = window.preferencesManager.getFormattedTimeUntilSleep();
                
                document.getElementById('sleep-duration').textContent = `${schedule.duration}h sleep duration`;
                document.getElementById('time-until-sleep').textContent = timeUntil;
            }
        }

        // Update volume display
        function updateVolumeDisplay() {
            const volumeSlider = document.getElementById('sound-volume-pref');
            const volumeDisplay = document.querySelector('.volume-display');
            if (volumeSlider && volumeDisplay) {
                volumeDisplay.textContent = volumeSlider.value + '%';
            }
        }

        // Form submission
        document.getElementById('preferences-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const preferences = {};
            
            for (let [key, value] of formData.entries()) {
                if (e.target.querySelector(`[name="${key}"]`).type === 'checkbox') {
                    preferences[key] = e.target.querySelector(`[name="${key}"]`).checked;
                } else {
                    preferences[key] = value;
                }
            }
            
            window.preferencesManager.updateFromForm(preferences);
            showSuccess('Preferences saved successfully!');
        });

        // Event listeners
        document.getElementById('sound-volume-pref').addEventListener('input', updateVolumeDisplay);
        document.getElementById('sleep-time').addEventListener('change', updateScheduleInfo);
        document.getElementById('wake-time').addEventListener('change', updateScheduleInfo);

        // Navigation functions
        function goBack() {
            window.location.href = 'index.html';
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }

        function showProfile() {
            alert('Profile feature coming soon!');
        }

        function showAnalytics() {
            window.location.href = 'analytics.html';
        }

        function upgradePremium() {
            alert('Premium upgrade coming soon! This will include:\n‚Ä¢ Advanced preferences\n‚Ä¢ Custom themes\n‚Ä¢ Priority support\n‚Ä¢ Premium sounds');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Preference functions
        function resetPreferences() {
            if (confirm('Are you sure you want to reset all preferences to defaults?')) {
                window.preferencesManager.resetToDefaults();
                loadPreferencesForm();
                updateScheduleInfo();
                showSuccess('Preferences reset to defaults!');
            }
        }

        function exportPreferences() {
            if (window.preferencesManager) {
                const data = window.preferencesManager.exportPreferences();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `co-sleep-preferences-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function importPreferences() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (window.preferencesManager.importPreferences(data)) {
                                loadPreferencesForm();
                                updateScheduleInfo();
                                showSuccess('Preferences imported successfully!');
                            } else {
                                showError('Invalid preferences file');
                            }
                        } catch (error) {
                            showError('Error reading preferences file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Utility functions
        function showSuccess(message) {
            // Create success notification
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.innerHTML = `<i class="fas fa-check"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showError(message) {
            // Create error notification
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html> 